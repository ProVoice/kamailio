#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
export DH_VERBOSE=1

export DEB_BUILD_MAINT_OPTIONS = hardening=+all
DPKG_EXPORT_BUILDFLAGS = 1

include /usr/share/dpkg/architecture.mk
include /usr/share/dpkg/buildflags.mk
include /usr/share/dpkg/pkg-info.mk

# Enable parallel builds.
NUMJOBS = 1
ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
  NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
  MAKEFLAGS += -j$(NUMJOBS)
endif

export JAVA_HOME=/usr/lib/jvm/java-gcj
export FREERADIUS=1
export WOLFSSL_INTERNAL=no
# tlsa
export KTLS_INCLUDE_TLSA=yes
export LIBSSL_STATIC_SRCLIB=yes
export LIBSSL_STATIC_SRCPATH=/usr/$(LIBDIR)

# Modules not in the "main" kamailio package:
EXCLUDED_MODULES =
EXCLUDED_MODULES += mono
EXCLUDED_MODULES += geoip

# Extra modules to skip, because they are not compilable now:
# - regardless if they go to the main kamailio package or to some module
#   package, they will be excluded from compile and install of all.
EXTRA_EXCLUDED_MODULES += bdb
EXTRA_EXCLUDED_MODULES += dbtext
EXTRA_EXCLUDED_MODULES += oracle
EXTRA_EXCLUDED_MODULES += pa
EXTRA_EXCLUDED_MODULES += iptrtpproxy
EXTRA_EXCLUDED_MODULES += systemd
EXTRA_EXCLUDED_MODULES += geoip2
EXTRA_EXCLUDED_MODULES += phonenum
EXTRA_EXCLUDED_MODULES += mongodb
EXTRA_EXCLUDED_MODULES += ruby
EXTRA_EXCLUDED_MODULES += mqtt
EXTRA_EXCLUDED_MODULES += secsipid
EXTRA_EXCLUDED_MODULES += lwsc
EXTRA_EXCLUDED_MODULES += nats
EXTRA_EXCLUDED_MODULES += tls_wolfssl
EXTRA_EXCLUDED_MODULES += kafka
## --EXCLUDED--


# Module groups that are packaged in separate packages (with the name
# kamailio-$(group_name)-modules).
# Note: the order is important (should be in dependency order, the one
# on which other depend first)
PACKAGE_GROUPS += mysql
PACKAGE_GROUPS += postgres
PACKAGE_GROUPS += berkeley
PACKAGE_GROUPS += unixodbc
PACKAGE_GROUPS += radius
PACKAGE_GROUPS += presence
PACKAGE_GROUPS += ldap
PACKAGE_GROUPS += xml
PACKAGE_GROUPS += perl
PACKAGE_GROUPS += utils
PACKAGE_GROUPS += lua
PACKAGE_GROUPS += memcached
PACKAGE_GROUPS += snmpstats
PACKAGE_GROUPS += xmpp
PACKAGE_GROUPS += cpl
PACKAGE_GROUPS += redis
PACKAGE_GROUPS += python
PACKAGE_GROUPS += sqlite
PACKAGE_GROUPS += json
PACKAGE_GROUPS += ims
PACKAGE_GROUPS += sctp
PACKAGE_GROUPS += java
PACKAGE_GROUPS += tls
PACKAGE_GROUPS += outbound
PACKAGE_GROUPS += websocket
PACKAGE_GROUPS += autheph
PACKAGE_GROUPS += dnssec
PACKAGE_GROUPS += kazoo
PACKAGE_GROUPS += cnxcc
PACKAGE_GROUPS += erlang
PACKAGE_GROUPS += rabbitmq
PACKAGE_GROUPS += python3
PACKAGE_GROUPS += microhttpd

# Module groups to be packaged onto kamailio-extra-modules.
EXTRA_GROUPS += ev
EXTRA_GROUPS += gzcompress
EXTRA_GROUPS += jansson
EXTRA_GROUPS += uuid
EXTRA_GROUPS += http_async

CONFIG_MODULES := $(addprefix cfg_, $(PACKAGE_GROUPS))
INSTALL_MODULES := $(addprefix install_, $(PACKAGE_GROUPS))
BUILD_MODULES := $(addprefix build_, $(PACKAGE_GROUPS))

# https://wiki.debian.org/ReproducibleBuilds/
export DEB_CFLAGS_MAINT_APPEND=-DVERSION_NODATE

.PHONY: skip-modules $(BUILD_MODULES) $(CONFIG_MODULES) $(INSTALL_MODULES)
skip-modules:
	@echo "$(EXCLUDED_MODULES) $(EXTRA_EXCLUDED_MODULES)"

%:
	dh $@ --buildsystem=cmake

# tls_wolfssl => tls-wolfssl
$(CONFIG_MODULES): module = $(subst _,-,$(subst cfg_,,$@))
$(CONFIG_MODULES): grp = $(subst cfg_,,$@)
$(CONFIG_MODULES): config_standard
	dh_auto_configure -- \
		-B build/kamailio-$(module)-modules \
		-DUSE_GIT=OFF \
		-DEXCLUDE_MODULES="$(EXCLUDED_MODULES) $(EXTRA_EXCLUDED_MODULES)" \
		-DMODULE_GROUP_NAME="K$(shell echo "$(grp)"| tr '[:lower:]' '[:upper:]')"

config_extra:
	dh_auto_configure -- \
		-B build/kamailio-extra-modules \
		-DUSE_GIT=OFF \
		-DEXCLUDE_MODULES="$(EXCLUDED_MODULES) $(EXTRA_EXCLUDED_MODULES)" \
		-DMODULE_GROUP_NAME="$(shell echo "$(addprefix K, $(EXTRA_GROUPS))"| tr '[:lower:]' '[:upper:]')"

config_standard:
	dh_auto_configure -- \
		-B build/kamailio \
		-DUSE_GIT=OFF \
		-DEXCLUDE_MODULES="$(EXCLUDED_MODULES) $(EXTRA_EXCLUDED_MODULES)" \
		-DMODULE_GROUP_NAME="KSTANDARD"

override_dh_auto_configure: $(CONFIG_MODULES) config_extra

build_standard:
	dh_auto_build -pkamailio \
		-- --build build/kamailio

build_extra: build_standard
	dh_auto_build -pkamailio-extra-modules \
		-- --build build/kamailio-extra-modules

# tls_wolfssl => tls-wolfssl
$(BUILD_MODULES): module = $(subst _,-,$(subst build_,,$@))
$(BUILD_MODULES): build_standard
	dh_auto_build -pkamailio-$(module)-modules \
		-- --build build/kamailio-$(module)-modules

override_dh_auto_build: $(BUILD_MODULES) build_extra

# extra
install_extra:
	dh_auto_install -pkamailio-extra-modules \
		--destdir=debian/kamailio-extra-modules \
		-- --build build/kamailio-extra-modules

# tls_wolfssl => tls-wolfssl
$(INSTALL_MODULES): module = $(subst _,-,$(subst install_,,$@))
$(INSTALL_MODULES):
	dh_auto_install -pkamailio-$(module)-modules \
		--destdir=debian/kamailio-$(module)-modules \
		-- --build build/kamailio-$(module)-modules

override_dh_auto_install: $(INSTALL_MODULES) install_extra
	dh_auto_install -pkamailio \
		--destdir=debian/kamailio \
		-- --build build/kamailio
